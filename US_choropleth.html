<!DOCTYPE html>
<html lang="en">
<style>
    body {
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
    }
    
    .topnav {
        overflow: hidden;
        background-color: #333;
    }
    
    .topnav a {
        float: left;
        color: #f2f2f2;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
        font-size: 17px;
    }
    
    .topnav a:hover {
        background-color: #ddd;
        color: black;
    }
    
    .topnav a.active {
        background-color: #4CAF50;
        color: white;
    }
    
    .tab {
        overflow: hidden;
        background-color: #c7760d;
        font-size: 20px;
    }
    
    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
    }
    
    .tab button:hover {
        background-color: rgb(102, 100, 100);
    }
    
    .tabcontent {
        display: none;
        padding: 6px 12px;
        border: 1px solid rgb(17, 16, 16);
        border-top: none;
    }
</style>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="style.css" />
    <title>Aastha's Portfolio</title>
</head>

<body>
    <div class="topnav">
        <a href="index.html">About</a>
        <a href="visual.html">Visualization</a>
        <a href="svg.html">SVG</a>
        <a href="ref.html">References</a>
        <a href="HW2.html">HW2</a>
    </div>
    <header>
        <h1>Visualisation of Gun shootings across the US between 2012-2013</h1>
        <h3 style="color:black;">
          Below is the visualisation of the data with respect to the states as well as cities 
          on a US Choropleth map with dynamic bar charts indicating the age groups and gender distribution 
          over a geographical region when hovered over the region.
        </h3>  
      </header>
    <div class="tab">
        <button class="tablinks" onclick="generateMapStates()" style="color: black;">State view</button>
        <button class="tablinks" onclick="generateMapCityView()" style="color: black;">State View with Cities</button>
        <button class="tablinks" onclick="generateMapCities()" style="color: black;">City View</button>
    </div>

    <h3 style="margin-left: 20px; font-size: 20px;">Age Group
    <select id="agegroups" onchange="generateMap()"> 
    <option value="-1" >All</option> 
      <option value="1.0">Age Group 1</option> 
      <option value="2.0">Age Group 2</option> 
      <option value="3.0">Age Group 3</option> 
    </select>
    Gender
    <select id="gender" onchange="generateMap()"> 
    <option value="-1">All</option> 
    <option value="M">Male</option> 
    <option value="F">Female</option> 
    </select>
    </h3>


    <script src="https://d3js.org/d3.v4.min.js"></script>

    <style type="text/css">
        
        body {
            font: 11px sans-serif;
            background-color: #ffffff;
        }
        
        .legend {
            position: absolute;
            left: 20px;
            top: 30px;
        }
        
        .axis text {
            font: 10px sans-serif;
        }
        
        .axis line,
        .axis path {
            fill: none;
            stroke: rgb(0, 0, 0);
            shape-rendering: crispEdges;
        }
        
        div.tooltip {
            position: absolute;
            text-align: center;
            width: 300px;
            height: 150px;
            padding: 2px;
            font: 12px sans-serif;
            background: white;
            border: 1px;
            border-radius: 8px;
            pointer-events: none;
            box-shadow: 2px;
        }
    </style>
    <script src="https://unpkg.com/topojson@3"></script> 
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.js"></script>
    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.3/d3-tip.min.js"></script>

    <script type="text/javascript">
        var width = 960;
        var height = 800;
        var lowColor = '#1b9e77'
        var highColor = '#7570b3'
        var ageGroup1Color = '#e7e1ef'
        var ageGroup2Color = '#c994c7'
        var ageGroup3Color = '#dd1c77'
        var color_range = ['#f7fbff', '#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#08519c', '#08306b']
        var projection = d3.geoAlbersUsa()
            .translate([width / 2, height / 2]) 
            .scale([1000]); 
        var toggle = 0
        function generateMapStates() {
            toggle = 0
            var path = d3.geoPath()
                .projection(projection); 
            states_data = "state_frequency.csv"
            d3.selectAll("svg").remove()
            
            var svg = d3.select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            var viewByAge = document.getElementById('agegroups');
            var valueAge = viewByAge.options[viewByAge.selectedIndex].value;
            var viewByGender = document.getElementById('gender');
            var valueGender = viewByGender.options[viewByGender.selectedIndex].value;
            d3.csv(states_data, function(data) {
                var dataArray = [];
                var maxVal = 0
                for (var d = 0; d < data.length; d++) {
                    if ((valueAge == -1 || (valueAge == 1 && data[d].ageGroup <= 1) || valueAge == data[d].ageGroup) && (valueGender == -1 || valueGender == data[d].gender)) {
                        dataArray.push(data[d])
                    }
                }
                var groupedData = dataArray.reduce((acc, it) => {
                    acc[it.state] = acc[it.state] + +it.count || +it.count;
                    return acc;
                }, {});
                var groupedDataMale = dataArray
                    .filter(x => x.gender == 'M')
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataFemale = dataArray
                    .filter(x => x.gender == 'F')
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup1 = dataArray
                    .filter(x => x.ageGroup == 1.0)
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup2 = dataArray
                    .filter(x => x.ageGroup == 2.0)
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup3 = dataArray
                    .filter(x => x.ageGroup == 3.0)
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var minVal = 0
                d3.json("us-states.json", function(json) {
                    Object.keys(groupedData).forEach(function(key) {
                        var dataState = key;
                        var dataValue = groupedData[key];
                        maxVal = Math.max(maxVal, dataValue);
                        for (var j = 0; j < json.features.length; j++) {
                            var jsonState = json.features[j].properties.name;
                            if (dataState == jsonState) {
                                json.features[j].properties.value = dataValue;
                                break;
                            }
                        }
                    })
                    d3.functor = function functor(v) {
                        return typeof v === "function" ? v : function() {
                            return v;
                        };
                    };
                    var tip = d3.tip()
                        .attr("class", "d3-tip")
                        .offset([-40, 0])
                        .html(function(d) {
                            var x = +d.properties.value;
                            return
                            +"<div id='tipDiv'></div><br>"
                        });
                    svg.call(tip);
                    var ramp = d3.scaleSequential(d3.interpolatePuRd).domain([minVal, maxVal])
                    var div = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0)
                    svg.selectAll("path")
                    .data(json.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .attr("transform", "translate(0,-100)")
                        .style("stroke", "black")
                        .style("stroke-width", "1")
                        .style("fill", function(d) {
                            return ramp(d.properties.value === undefined ? 0 : d.properties.value)
                        })
                    .on("mouseover", function(d) {
                        d3.selectAll("#tipDiv").remove()
                        val = d.properties.value
                        if (!val) {
                            val = 0
                        }
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Total no of shootings in " + d.properties.name + " were: " + val
                        )
                        .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                        tip.show(d);
                        var state = d.properties.name;
                        var dataset = [
                            groupedDataMale[state] || 0,
                            groupedDataFemale[state] || 0,
                            groupedDataAgeGroup1[state] || 0,
                            groupedDataAgeGroup2[state] || 0,
                            groupedDataAgeGroup3[state] || 0
                        ];
                        var barHeight = 25;
                        var tipSVG =
                            div
                            .append("svg")
                            .attr("width", 150)
                            .attr("height", barHeight * 5);
                        var x = d3.scaleLinear()
                            .domain([0, d3.max(dataset)])
                            .range([0, 150]);
                        var bar = tipSVG.selectAll("g")
                            .data(dataset)
                            .enter().append("g")
                            .attr("transform", function(d, i) {
                                return "translate(0," + i * barHeight + ")";
                            });
                        bar.append("rect")
                            .attr("width", 50)
                            .transition()
                            .duration(1000)
                            .attr("width", x)
                            .attr("height", barHeight - 1)
                            .attr("fill", function(d, i) {
                                switch (i) {
                                    case 0:
                                        return highColor
                                    case 1:
                                        return lowColor
                                    case 2:
                                        return ageGroup1Color
                                    case 3:
                                        return ageGroup2Color
                                    case 4:
                                        return ageGroup3Color
                                }
                            });
                        bar.append("text")
                            .attr("x", 2)
                            .attr("y", barHeight / 2)
                            .attr("dy", ".35em")
                            .attr("fill", function(d) {
                                if (d === d3.max(dataset)) {
                                    return "black";
                                } else {
                                    return "black";
                                }
                            })
                            .style("font-size", "12px")
                            .text(function(d, i) {
                                switch (i) {
                                    case 0:
                                        return "Males: " + d
                                    case 1:
                                        return "Females: " + d
                                    case 2:
                                        return "Age Group 1: " + d
                                    case 3:
                                        return "Age Group 2: " + d
                                    case 4:
                                        return "Age Group 3: " + d
                                }
                            });
                    })
                    .on("mouseout", function(d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
                    axisScale = d3.scaleLinear()
                        .domain(ramp.domain())
                        .range([50, 550])
                    axisBottom = g => g
                        .attr("class", `x-axis`)
                        .attr("transform", "translate(10,570)")
                        .call(d3.axisBottom(axisScale)
                            .ticks(10)
                            .tickSize(-10))
                    const linearGradient = svg.append("linearGradient")
                        .attr("id", "linear-gradient");
                    linearGradient.selectAll("stop")
                        .data(ramp.ticks().map((t, i, n) => ({
                            offset: `${100*i/n.length}%`,
                            color: ramp(t)
                        })))
                        .enter().append("stop")
                        .attr("offset", d => d.offset)
                        .attr("stop-color", d => d.color)
                    svg.append('g')
                        .attr("transform", "translate(50,500)")
                        .append("rect")
                        .attr("transform", "translate(10,50)")
                        .attr("width", 501)
                        .attr("height", 20)
                        .style("fill", "url(#linear-gradient)");
                    svg.append('g')
                        .call(axisBottom);
                });
            });
        }

        function generateMapCityView() {
            var color_range = ['#ffffe5',
                '#f7fcb9',
                '#d9f0a3',
                '#addd8e',
                '#78c679',
                '#41ab5d',
                '#238443',
                '#006837',
                '#004529'
            ]
            var ageGroup1Color = '#fff7bc'
            var ageGroup2Color = '#fec44f'
            var ageGroup3Color = '#d95f0e'
            toggle = 2
            var path = d3.geoPath() 
                .projection(projection); 
            
            d3.selectAll("svg").remove()
            var svg = d3.select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            var viewByAge = document.getElementById('agegroups');
            var valueAge = viewByAge.options[viewByAge.selectedIndex].value;
            var viewByGender = document.getElementById('gender');
            var valueGender = viewByGender.options[viewByGender.selectedIndex].value;
            d3.csv("city_frequency1.csv", function(data) {
                var dataArray = [];
                var dataArrayUnique = [];
                var citiesUnique = new Set();
                var maxVal = 0
                for (var d = 0; d < data.length; d++) {
                    if ((valueAge == -1 || (valueAge == 1 && data[d].ageGroup <= 1) || valueAge == data[d].ageGroup) && (valueGender == -1 || valueGender == data[d].gender)) {
                        dataArray.push(data[d])
                        if (!citiesUnique.has(data[d].city)) {
                            citiesUnique.add(data[d].city)
                            dataArrayUnique.push(data[d])
                        }
                    }
                }
                var groupedData = dataArray.reduce((acc, it) => {
                    acc[it.state] = acc[it.state] + +it.count || +it.count;
                    return acc;
                }, {});
                var groupedDataMale = dataArray
                    .filter(x => x.gender == 'M')
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataFemale = dataArray
                    .filter(x => x.gender == 'F')
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup1 = dataArray
                    .filter(x => x.ageGroup == 1.0)
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup2 = dataArray
                    .filter(x => x.ageGroup == 2.0)
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup3 = dataArray
                    .filter(x => x.ageGroup == 3.0)
                    .reduce((acc, it) => {
                        acc[it.state] = acc[it.state] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataCity = dataArray
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataMaleCity = dataArray
                    .filter(x => x.gender == 'M')
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataFemaleCity = dataArray
                    .filter(x => x.gender == 'F')
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup1City = dataArray
                    .filter(x => x.ageGroup == 1.0)
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup2City = dataArray
                    .filter(x => x.ageGroup == 2.0)
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup3City = dataArray
                    .filter(x => x.ageGroup == 3.0)
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var minVal = 0
                d3.json("us-states.json", function(json) {
                    Object.keys(groupedData).forEach(function(key) {
                        var dataCity = key;
                        var dataValue = groupedData[key];
                        maxVal = Math.max(maxVal, dataValue);
                        for (var j = 0; j < json.features.length; j++) {
                            var jsonState = json.features[j].properties.name;
                            if (dataCity == jsonState) {
                                json.features[j].properties.value = dataValue;
                                break;
                            }
                        }
                    })
                    d3.functor = function functor(v) {
                        return typeof v === "function" ? v : function() {
                            return v;
                        };
                    };
                    var tip = d3.tip()
                        .attr("class", "d3-tip")
                        .offset([-40, 0])
                        .html(function(d) {
                            var x = +d.properties.value;
                            return
                            +"<div id='tipDiv'></div><br>"
                        });
                    svg.call(tip);
                    var ramp = d3.scaleSequential(d3.interpolateYlOrBr).domain([minVal, maxVal])
                    var div = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0)
                    svg.selectAll("path")
                        .data(json.features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .attr("transform", "translate(0,-100)")
                        .style("stroke", "black")
                        .style("stroke-width", "1")
                        .style("fill", function(d) {
                            return ramp(d.properties.value === undefined ? 0 : d.properties.value)
                        })
                    .on("mouseover", function(d) {
                        d3.selectAll("#tipDiv").remove()
                        val = d.properties.value
                        if (!val) {
                            val = 0
                        }
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html("Total no of shootings in " + d.properties.name + " were: " + val)
                        .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                        tip.show(d);
                        var state = d.properties.name;
                        var dataset = [
                            groupedDataMale[state] || 0,
                            groupedDataFemale[state] || 0,
                            groupedDataAgeGroup1[state] || 0,
                            groupedDataAgeGroup2[state] || 0,
                            groupedDataAgeGroup3[state] || 0
                        ];
                        var barHeight = 25;
                        var tipSVG =
                            div
                            .append("svg")
                            .attr("width", 150)
                            .attr("height", barHeight * 5);
                        var x = d3.scaleLinear()
                            .domain([0, d3.max(dataset)])
                            .range([0, 150]);
                        var bar = tipSVG.selectAll("g")
                            .data(dataset)
                            .enter().append("g")
                            .attr("transform", function(d, i) {
                                return "translate(0," + i * barHeight + ")";
                            });
                        bar.append("rect")
                            .attr("width", 50)
                            .transition()
                            .duration(1000)
                            .attr("width", x)
                            .attr("height", barHeight - 1)
                            .attr("fill", function(d, i) {
                                switch (i) {
                                    case 0:
                                        return highColor
                                    case 1:
                                        return lowColor
                                    case 2:
                                        return ageGroup1Color
                                    case 3:
                                        return ageGroup2Color
                                    case 4:
                                        return ageGroup3Color
                                }
                            });
                        bar.append("text")
                            .attr("x", 2)
                            .attr("y", barHeight / 2)
                            .attr("dy", ".35em")
                            .attr("fill", function(d) {
                                return "black";
                            })
                            .style("font-size", "12px")
                            .text(function(d, i) {
                                switch (i) {
                                    case 0:
                                        return "Males: " + d
                                    case 1:
                                        return "Females: " + d
                                    case 2:
                                        return "Age Group 1: " + d
                                    case 3:
                                        return "Age Group 2: " + d
                                    case 4:
                                        return "Age Group 3: " + d
                                }
                            });
                    })
                    .on("mouseout", function(d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
                    axisScale = d3.scaleLinear()
                        .domain(ramp.domain())
                        .range([50, 550])
                    axisBottom = g => g
                        .attr("class", `x-axis`)
                        .attr("transform", "translate(10,570)")
                        .call(d3.axisBottom(axisScale)
                            .ticks(10)
                            .tickSize(-10))
                    const linearGradient = svg.append("linearGradient")
                        .attr("id", "linear-gradient");
                    linearGradient.selectAll("stop")
                        .data(ramp.ticks().map((t, i, n) => ({
                            offset: `${100*i/n.length}%`,
                            color: ramp(t)
                        })))
                        .enter().append("stop")
                        .attr("offset", d => d.offset)
                        .attr("stop-color", d => d.color)
                    svg.append('g')
                        .attr("transform", "translate(50,500)")
                        .append("rect")
                        .attr("transform", "translate(10,50)")
                        .attr("width", 501)
                        .attr("height", 20)
                        .style("fill", "url(#linear-gradient)");
                    svg.append('g')
                        .call(axisBottom);
                });
                var tip = d3.tip()
                    .attr("class", "d3-tip")
                    .offset([-40, 0])
                    .html(function(d) {
                        var x = +d.count;
                        return
                        +"<div id='tipDiv'></div><br>"
                    });
                svg.call(tip);
                var max_radius = 30
                var div = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0)
                setTimeout(() => {
                    svg.selectAll("circle")
                        .data(dataArrayUnique)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d) {
                            return projection([d.lng, d.lat])[0];
                        })
                        .attr("cy", function(d) {
                            return projection([d.lng, d.lat])[1];
                        })
                        .attr("r", function(d) {
                            return max_radius * Math.sqrt(groupedDataCity[d.city] / maxVal)
                        })
                        .attr("transform", "translate(0,-100)")
                        .style("stroke", "blue")
                        .style("stroke-width", 1)
                        .style("opacity", 0.5)
                        .style("fill", "blue")
                    .on("mouseover", function(d) {
                        d3.selectAll("#tipDiv").remove()
                        val = d.count
                        if (!val) {
                            val = 0
                        }
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        if (!groupedDataAgeGroup1[d.city]) {
                            var agegroup1 = 0
                        } else {
                            var agegroup1 = groupedDataAgeGroup1[d.city]
                        }
                        if (!groupedDataAgeGroup2[d.city]) {
                            var agegroup2 = 0
                        } else {
                            var agegroup2 = groupedDataAgeGroup2[d.city]
                        }
                        if (!groupedDataAgeGroup3[d.city]) {
                            var agegroup3 = 0
                        } else {
                            var agegroup3 = groupedDataAgeGroup3[d.city]
                        }
                        div.html("Total no of shootings in " + d.city + "were: " + d.count)
                        .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                        tip.show(d);
                        var city = d.city;
                        var dataset = [
                            groupedDataMaleCity[city] || 0,
                            groupedDataFemaleCity[city] || 0,
                            groupedDataAgeGroup1City[city] || 0,
                            groupedDataAgeGroup2City[city] || 0,
                            groupedDataAgeGroup3City[city] || 0
                        ]
                        var barHeight = 25;
                        var tipSVG =
                            div
                            .append("svg")
                            .attr("width", 150)
                            .attr("height", barHeight * 5);
                        var x = d3.scaleLinear()
                            .domain([0, d3.max(dataset)])
                            .range([0, 150]);
                        var bar = tipSVG.selectAll("g")
                            .data(dataset)
                            .enter().append("g")
                            .attr("transform", function(d, i) {
                                return "translate(0," + i * barHeight + ")";
                            });
                        bar.append("rect")
                            .attr("width", 50)
                            .transition()
                            .duration(1000)
                            .attr("width", x)
                            .attr("height", barHeight - 1)
                            .attr("fill", function(d, i) {
                                switch (i) {
                                    case 0:
                                        return highColor
                                    case 1:
                                        return lowColor
                                    case 2:
                                        return ageGroup1Color
                                    case 3:
                                        return ageGroup2Color
                                    case 4:
                                        return ageGroup3Color
                                }
                            });
                        bar.append("text")
                            .attr("x", 2)
                            .attr("y", barHeight / 2)
                            .attr("dy", ".35em")
                            .attr("fill", function(d) {
                                if (d === d3.max(dataset)) {
                                    return "black";
                                } else {
                                    return "black";
                                }
                            })
                            .style("font-size", "12px")
                            .text(function(d, i) {
                                switch (i) {
                                    case 0:
                                        return "Males: " + d
                                    case 1:
                                        return "Females: " + d
                                    case 2:
                                        return "Age Group 1: " + d
                                    case 3:
                                        return "Age Group 2: " + d
                                    case 4:
                                        return "Age Group 3: " + d
                                }
                            });
                    })
                    .on("mouseout", function(d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
                }, 15)
            });
        }

        function generateMapCities() {
            toggle = 1
            var path = d3.geoPath() 
            city_data = "city_frequency1.csv"
            d3.selectAll("svg").remove()
            var svg = d3.select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            var viewByAge = document.getElementById('agegroups');
            var valueAge = viewByAge.options[viewByAge.selectedIndex].value;
            var viewByGender = document.getElementById('gender');
            var valueGender = viewByGender.options[viewByGender.selectedIndex].value;
            d3.csv(city_data, function(data) {
                var dataArray = [];
                var maxVal = 0
                for (var d = 0; d < data.length; d++) {
                    if ((valueAge == -1 || (valueAge == 1 && data[d].ageGroup <= 1) || valueAge == data[d].ageGroup) &&
                        (valueGender == -1 || valueGender == data[d].gender)) {
                        dataArray.push(data[d])
                    }
                }
                var groupedData = dataArray.reduce((acc, it) => {
                    acc[it.city] = acc[it.city] + +it.count || +it.count;
                    return acc;
                }, {});
                var groupedDataMale = dataArray
                    .filter(x => x.gender == 'M')
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataFemale = dataArray
                    .filter(x => x.gender == 'F')
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup1 = dataArray
                    .filter(x => x.ageGroup == 1.0)
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup2 = dataArray
                    .filter(x => x.ageGroup == 2.0)
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var groupedDataAgeGroup3 = dataArray
                    .filter(x => x.ageGroup == 3.0)
                    .reduce((acc, it) => {
                        acc[it.city] = acc[it.city] + +it.count || +it.count;
                        return acc;
                    }, {});
                var minVal = 0
                d3.json("counties-albers.json", function(json) {
                    Object.keys(groupedData).forEach(function(key) {
                        var dataCity = key;
                        var dataValue = groupedData[key];
                        maxVal = Math.max(maxVal, dataValue);
                        for (var j = 0; j < json.objects.counties.geometries.length; j++) {
                            var jsonCity = json.objects.counties.geometries[j].properties.name;
                            if (dataCity == jsonCity) {
                                json.objects.counties.geometries[j].properties.value = dataValue;
                                break;
                            }
                        }
                    })
                    d3.functor = function functor(v) {
                        return typeof v === "function" ? v : function() {
                            return v;
                        };
                    };
                    var tip = d3.tip()
                        .attr("class", "d3-tip")
                        .offset([-40, 0])
                        .html(function(d) {
                            var x = +d.properties.value;
                            return
                            +"<div id='tipDiv'></div><br>"
                        });
                    svg.call(tip);
                    var ramp = d3.scaleSequential(d3.interpolatePuRd).domain([minVal, maxVal])
                    var div = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0)
                    svg.selectAll("path")
                    .data(topojson.feature(json, json.objects.counties).features)
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .style("stroke", "grey")
                        .style("stroke-width", "1")
                        .style("fill", function(d) {
                            return ramp(d.properties.value === undefined ? 0 : d.properties.value)
                        })
                    .on("mouseover", function(d) {
                        d3.selectAll("#tipDiv").remove()
                        val = d.properties.value
                        if (!val) {
                            val = 0
                        }
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        if (!groupedDataAgeGroup1[d.properties.name]) {
                            var agegroup1 = 0
                        } else {
                            var agegroup1 = groupedDataAgeGroup1[d.properties.name]
                        }
                        if (!groupedDataAgeGroup2[d.properties.name]) {
                            var agegroup2 = 0
                        } else {
                            var agegroup2 = groupedDataAgeGroup2[d.properties.name]
                        }
                        if (!groupedDataAgeGroup3[d.properties.name]) {
                            var agegroup3 = 0
                        } else {
                            var agegroup3 = groupedDataAgeGroup3[d.properties.name]
                        }
                        div.html("Total no of shootings in " + d.properties.name + " were: " + val)
                        .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                        tip.show(d);
                        var city = d.properties.name;
                        var dataset = [
                            groupedDataMale[city] || 0,
                            groupedDataFemale[city] || 0,
                            groupedDataAgeGroup1[city] || 0,
                            groupedDataAgeGroup2[city] || 0,
                            groupedDataAgeGroup3[city] || 0
                        ];
                        var barHeight = 25;
                        var tipSVG =
                            div
                            .append("svg")
                            .attr("width", 150)
                            .attr("height", barHeight * 5);
                        var x = d3.scaleLinear()
                            .domain([0, d3.max(dataset)])
                            .range([0, 150]);
                        var bar = tipSVG.selectAll("g")
                            .data(dataset)
                            .enter().append("g")
                            .attr("transform", function(d, i) {
                                return "translate(0," + i * barHeight + ")";
                            });
                        bar.append("rect")
                            .attr("width", 50)
                            .transition()
                            .duration(1000)
                            .attr("width", x)
                            .attr("height", barHeight - 1)
                            .attr("fill", function(d, i) {
                                switch (i) {
                                    case 0:
                                        return highColor
                                    case 1:
                                        return lowColor
                                    case 2:
                                        return ageGroup1Color
                                    case 3:
                                        return ageGroup2Color
                                    case 4:
                                        return ageGroup3Color
                                }
                            });
                        bar.append("text")
                            .attr("x", 2)
                            .attr("y", barHeight / 2)
                            .attr("dy", ".35em")
                            .attr("fill", function(d) {
                                if (d === d3.max(dataset)) {
                                    return "black";
                                } else {
                                    return "black";
                                }
                            })
                            .style("font-size", "12px")
                            .text(function(d, i) {
                                switch (i) {
                                    case 0:
                                        return "Males: " + d
                                    case 1:
                                        return "Females: " + d
                                    case 2:
                                        return "Age Group 1: " + d
                                    case 3:
                                        return "Age Group 2: " + d
                                    case 4:
                                        return "Age Group 3: " + d
                                }
                            });
                    })
                    .on("mouseout", function(d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
                    svg.append("path")
                        .datum(topojson.mesh(json, json.objects.states, (a, b) => a !== b))
                        .attr("fill", "none")
                        .attr("stroke", "black")
                        .attr("stroke-linejoin", "round")
                        .attr("d", path)
                    axisScale = d3.scaleLinear()
                        .domain(ramp.domain())
                        .range([50, 550])
                    axisBottom = g => g
                        .attr("class", `x-axis`)
                        .attr("transform", "translate(10,670)")
                        .call(d3.axisBottom(axisScale)
                            .ticks(10)
                            .tickSize(-10))
                    const linearGradient = svg.append("linearGradient")
                        .attr("id", "linear-gradient");
                    linearGradient.selectAll("stop")
                        .data(ramp.ticks().map((t, i, n) => ({
                            offset: `${100*i/n.length}%`,
                            color: ramp(t)
                        })))
                        .enter().append("stop")
                        .attr("offset", d => d.offset)
                        .attr("stop-color", d => d.color)
                    svg.append("text")
                        .text('Number')
                    svg.append('g')
                        .attr("transform", "translate(50,600)")
                        .append("rect")
                        .attr("transform", "translate(10,50)")
                        .attr("width", 501)
                        .attr("height", 20)
                        .style("fill", "url(#linear-gradient)");
                    svg.append('g')
                        .call(axisBottom);
                });
            });
        }

        function generateMap() {
            if (toggle == 0) {
                generateMapStates()
            } else if (toggle == 2) {
                generateMapCityView()
            } else {
                generateMapCities()
            }
        }
        generateMap()
    </script>

</body>

</html>